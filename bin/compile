#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# debug
# set -x

function topic() 
{
    echo "-----> $*"
}

BUILD_DIR=$1
PREFIX_DIR=${HOME}/.apt/usr
DICT_DIR=${PREFIX_DIR}/share/aspell/
ASPELL_DIR=${PREFIX_DIR}/lib/aspell/
lang=en

topic "Remove old aspell symlink"
rm ${BUILD_DIR}/.apt/usr/lib/aspell/*.rws

DICT_FILES=""
for x in `ls -C1 ${BUILD_DIR}/.apt/usr/share/aspell/*.cwl.gz`
do
    filename=`basename $x`
    DICT_FILES="${DICT_FILES} ${DICT_DIR}/$filename"
done

topic "Writing profile script"
cat <<EOF >${BUILD_DIR}/.profile.d/005_enchant.sh

for x in ${DICT_FILE}; 
do 
    base=`basename $x .cwl.gz`; 
    zcat ${x} | precat | aspell --prefix=${PREFIX_DIR} --local-data-dir=${ASPELL_DIR} --lang=${lang} create master ${base}.rws; 
done

ln -s ${PREFIX_DIR}/lib/x86_64-linux-gnu/enchant/libenchant_aspell.so ${HOME}/.enchant/libenchant_aspell.so
cp ${ASPELL_DIR}/* ${HOME}/.enchant/

EOF

topic "creating .enchant"
mkdir ${BUILD_DIR}/.enchant

# cp ${PREFIX_DIR}/lib/x86_64-linux-gnu/enchant/libenchant_aspell.so ${BUILD_DIR}/.enchant/libenchant_aspell.so
# cp ${PREFIX_DIR}/lib/aspell/* ${BUILD_DIR}/.enchant/
# cp ${HOME}/lib/aspell/* ${BUILD_DIR}/.enchant/
